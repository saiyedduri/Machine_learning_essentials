<!DOCTYPE html>
<html lang="en" data-theme="light" style="color-scheme: light;">
<head>
    <!-- Use modern UTF-8 declaration -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Hi there! - I'm Pilsner by Lervig. Let's chat!</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            overflow: hidden;
            width: 100dvw;
            height: 100dvh;
            background-color: #f3f4f6;
        }

        .chat-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 100%;
            max-width: 768px;
            margin: auto;
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            position: relative; /* Added for absolute positioning context */
        }

        .chat-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem 1rem;
            border-bottom: 1px solid #e5e7eb;
            text-align: center;
            flex-grow: 1;
            transition: all 0.3s ease-in-out;
            flex-shrink: 0; /* Prevent shrinking */
        }

        .chat-header.minimized {
            flex-grow: 0;
            padding: 1rem;
            flex-direction: row;
            justify-content: flex-start;
            text-align: left;
        }

        .avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #3b82f6;
            margin-bottom: 1rem;
            transition: all 0.3s ease-in-out;
        }

        .chat-header.minimized .avatar {
            width: 50px;
            height: 50px;
            margin-bottom: 0;
            margin-right: 1rem;
        }

        .chat-title {
            font-size: 1.875rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 0.5rem;
            transition: all 0.3s ease-in-out;
        }

        .chat-header.minimized .chat-title {
            font-size: 1.25rem;
            margin-bottom: 0;
        }

        .chat-description {
            font-size: 1rem;
            color: #6b7280;
            line-height: 1.5;
            max-width: 90%;
            margin-top: 0.5rem;
            transition: all 0.3s ease-in-out;
        }

        .chat-header.minimized .chat-description {
            display: none;
        }

        .header-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: all 0.3s ease-in-out;
        }

        .chat-header.minimized .header-content {
            flex-direction: row;
            align-items: center;
        }

        /* Language selector positioned absolutely to not affect layout */
        .language-selector {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background-color: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
            z-index: 10;
            padding: 1rem;
            flex-wrap: wrap;
            gap: 0.5rem;
            justify-content: center;
            max-height: 100px;
            overflow-y: auto;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* Main content area that adjusts when language selector is visible */
        .main-content-area {
            display: flex;
            flex-direction: column;
            flex: 1;
            min-height: 0;
            transition: all 0.3s ease-in-out;
        }

        /* Add top margin when language selector is visible */
        .main-content-area.with-language-selector {
            margin-top: 100px; /* Height of language selector */
        }

        .chat-content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .message {
            max-width: 85%;
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            margin-bottom: 0.75rem;
            line-height: 1.4;
        }

        .user-message {
            background-color: #e5e7eb;
            align-self: flex-end;
            border-bottom-right-radius: 0.25rem;
        }

        .ai-message {
            background-color: #3b82f6;
            color: #fff;
            align-self: flex-start;
            border-bottom-left-radius: 0.25rem;
        }
        
        .ai-message a {
            color: #fff;
            text-decoration: underline;
        }

        .chat-input-area {
            display: flex;
            flex-shrink: 0;
            padding: 1rem;
            border-top: 1px solid #e5e7eb;
            align-items: center;
            background-color: #fff; /* Ensure solid background */
        }

        .input-text {
            flex-grow: 1;
            padding: 0.75rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 9999px;
            outline: none;
            transition: border-color 0.2s ease-in-out;
        }

        .input-text:focus {
            border-color: #3b82f6;
        }

        .send-button {
            margin-left: 0.5rem;
            padding: 0.75rem;
            background-color: #3b82f6;
            color: #fff;
            border-radius: 50%;
            transition: background-color 0.2s ease-in-out;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .send-button:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
        }

        .audio-tour-button {
            padding: 0.5rem 1rem;
            background-color: #10b981;
            color: #fff;
            border-radius: 9999px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
            margin-right: 0.5rem;
        }
        
        .audio-tour-button:hover {
            background-color: #059669;
        }

        .audio-tour-button.stop {
            background-color: #ef4444;
        }
        
        .audio-tour-button.stop:hover {
            background-color: #dc2626;
        }

        .language-button {
            padding: 0.5rem 1rem;
            background-color: #fff;
            color: #374151;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            font-size: 0.875rem;
        }

        .language-button:hover {
            background-color: #f3f4f6;
            border-color: #9ca3af;
        }

        .language-button.selected {
            background-color: #3b82f6;
            color: #fff;
            border-color: #3b82f6;
        }

        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-dots span {
            animation: blink 1s infinite;
        }
        .loading-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }
        .loading-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes blink {
            0%, 100% { opacity: 0.2; }
            50% { opacity: 1; }
        }
        
        .modal {
            display: none; 
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4); 
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #fff;
            margin: auto;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            text-align: center;
        }

        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        
        .close-button:hover,
        .close-button:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }

    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center p-4">
    <!-- Modal for custom alerts -->
    <div id="alert-modal" class="modal">
      <div class="modal-content">
        <span class="close-button">&times;</span>
        <p id="modal-message"></p>
      </div>
    </div>

    <div class="chat-container">
        <!-- Language Selector - Positioned absolutely -->
        <div id="language-selector" class="language-selector">
            <button class="language-button selected" data-lang="en" data-lang-name="English">ðŸ‡ºðŸ‡¸ English</button>
            <button class="language-button" data-lang="no" data-lang-name="Norwegian">ðŸ‡³ðŸ‡´ Norwegian</button>
            <button class="language-button" data-lang="fi" data-lang-name="Finnish">ðŸ‡«ðŸ‡® Finnish</button>
            <button class="language-button" data-lang="sv" data-lang-name="Swedish">ðŸ‡¸ðŸ‡ª Swedish</button>
            <button class="language-button" data-lang="de" data-lang-name="German">ðŸ‡©ðŸ‡ª German</button>
            <button class="language-button" data-lang="es" data-lang-name="Spanish">ðŸ‡ªðŸ‡¸ Spanish</button>
            <button class="language-button" data-lang="nl" data-lang-name="Dutch">ðŸ‡³ðŸ‡± Dutch</button>
        </div>

        <!-- Main content area -->
        <div id="main-content-area" class="main-content-area">
            <!-- Header -->
            <div class="chat-header" id="chat-header">
                <div class="header-content">
                    <img src="https://s3.us-east-1.amazonaws.com/cdn.speak-to.ai/avatars/pilsner-beer-by-lervig.png" alt="Pilsner by Lervig avatar" class="avatar">
                    <div>
                        <h1 class="chat-title">Hi there! I'm Pilsner by Lervig. Let's chat!</h1>
                        <p class="chat-description">I'm your guide to our Premium Norwegian Pilsner. From brewing and ingredients to flavor and packaging, I've got you covered. Ask me anything and I'll help you get to know the beer that's made for people who truly love beer.</p>
                    </div>
                </div>
            </div>

            <!-- Chat Content -->
            <div id="chat-content" class="chat-content"></div>

            <!-- Input Area -->
            <div class="chat-input-area">
                <button id="audio-tour-btn" class="audio-tour-button">Start Audio Tour</button>
                <input type="text" id="prompt-input" placeholder="Ask me anything..." class="input-text">
                <button id="send-button" class="send-button">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-send">
                        <line x1="22" y1="2" x2="11" y2="13"></line>
                        <polygon points="22 2 15.5 22 11 13 2 9 22 2"></polygon>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <script>
        // Custom modal for alerts
        function showModal(message) {
            const modal = document.getElementById('alert-modal');
            const modalMessage = document.getElementById('modal-message');
            const closeBtn = document.getElementsByClassName('close-button')[0];
            
            modalMessage.textContent = message;
            modal.style.display = "flex";

            closeBtn.onclick = function() {
                modal.style.display = "none";
            }
            window.onclick = function(event) {
                if (event.target == modal) {
                    modal.style.display = "none";
                }
            }
        }
        
        // This function is for fetching responses from the AI twin
        async function fetchResponse(twinName = 'pilsner-beer-by-lervig', question = 'Tell me about this product', maxRetries = 3) {
            const encodedTwin = encodeURIComponent(twinName);
            const encodedQuestion = encodeURIComponent(question);
            const url = `/speak-to-api/${encodedTwin}?q=${encodedQuestion}&target=JSON`;
            
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status} - ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    
                    const text = data.content || data.answer || data.response || 'No response found';
                    const followups = data.followups || data.suggestions || [];
                    
                    return {
                        text,
                        followups,
                        raw: data,
                        success: true
                    };
                } catch (error) {
                    console.error(`Attempt ${i + 1} failed to fetch from twin '${twinName}':`, error);
                    const delay = Math.pow(2, i) * 1000; // Exponential backoff: 1s, 2s, 4s
                    await new Promise(res => setTimeout(res, delay));
                }
            }
            
            return {
                text: '',
                followups: [],
                raw: null,
                success: false,
                error: `Failed to fetch from twin '${twinName}' after ${maxRetries} retries.`
            };
        }

        // Enhanced question generation class with secure OpenAI integration
        class GenerateQuery {
            constructor(twinName, options = {}) {
                this.twinName = twinName;
                this.isRunning = false;
                this.conversationHistory = [];
                this.responseBuffer = [];
                this.selectedLanguage = options.language || 'en';
                this.selectedLanguageName = options.languageName || 'English';
                
                this.config = {
                    maxIterations: options.maxIterations || 8,
                    delayBetweenQueries: options.delayBetweenQueries || 4000,
                    bufferSize: options.bufferSize || 20,
                    verbose: options.verbose || true,
                    openaiModel: options.openaiModel || 'gpt-3.5-turbo',
                    productType: options.productType || 'product',
                    companyName: options.companyName || this.extractCompanyName(twinName),
                    ...options
                };

                // Language mappings for speech synthesis
                this.languageConfig = {
                    'en': { code: 'en-US', name: 'English' },
                    'no': { code: 'nb-NO', name: 'Norwegian' },
                    'fi': { code: 'fi-FI', name: 'Finnish' },
                    'sv': { code: 'sv-SE', name: 'Swedish' },
                    'de': { code: 'de-DE', name: 'German' },
                    'es': { code: 'es-ES', name: 'Spanish' },
                    'nl': { code: 'nl-NL', name: 'Dutch' }
                };

                // Comprehensive multilingual question templates
                this.multilingualQuestions = this.initializeMultilingualQuestions();
            }

            // Initialize comprehensive multilingual question templates
            initializeMultilingualQuestions() {
                return {
                    introQuestions: {
                        en: {
                            beer: "I'm interested in learning about this beer - what makes it special?",
                            wine: "I'm curious about this wine - what should I know about it?",
                            coffee: "Tell me about this coffee - what makes it stand out?",
                            product: "I'm interested in learning about this product - what makes it special?"
                        },
                        no: {
                            beer: "Jeg er interessert i Ã¥ lÃ¦re om denne Ã¸len - hva gjÃ¸r den spesiell?",
                            wine: "Jeg er nysgjerrig pÃ¥ denne vinen - hva bÃ¸r jeg vite om den?",
                            coffee: "Fortell meg om denne kaffen - hva gjÃ¸r den unik?",
                            product: "Jeg er interessert i Ã¥ lÃ¦re om dette produktet - hva gjÃ¸r det spesielt?"
                        },
                        fi: {
                            beer: "Haluan oppia tÃ¤stÃ¤ oluesta - mikÃ¤ tekee siitÃ¤ erityisen?",
                            wine: "Olen utelias tÃ¤stÃ¤ viinistÃ¤ - mitÃ¤ minun pitÃ¤isi tietÃ¤Ã¤ siitÃ¤?",
                            coffee: "Kerro minulle tÃ¤stÃ¤ kahvista - mikÃ¤ tekee siitÃ¤ erityisen?",
                            product: "Haluan oppia tÃ¤stÃ¤ tuotteesta - mikÃ¤ tekee siitÃ¤ erityisen?"
                        },
                        sv: {
                            beer: "Jag Ã¤r intresserad av att lÃ¤ra mig om denna Ã¶l - vad gÃ¶r den speciell?",
                            wine: "Jag Ã¤r nyfiken pÃ¥ detta vin - vad bÃ¶r jag veta om det?",
                            coffee: "BerÃ¤tta fÃ¶r mig om detta kaffe - vad gÃ¶r det speciellt?",
                            product: "Jag Ã¤r intresserad av att lÃ¤ra mig om denna produkt - vad gÃ¶r den speciell?"
                        },
                        de: {
                            beer: "Ich interessiere mich fÃ¼r dieses Bier - was macht es besonders?",
                            wine: "Ich bin neugierig auf diesen Wein - was sollte ich darÃ¼ber wissen?",
                            coffee: "ErzÃ¤hl mir von diesem Kaffee - was macht ihn besonders?",
                            product: "Ich interessiere mich fÃ¼r dieses Produkt - was macht es besonders?"
                        },
                        es: {
                            beer: "Me interesa conocer esta cerveza - Â¿quÃ© la hace especial?",
                            wine: "Tengo curiosidad por este vino - Â¿quÃ© deberÃ­a saber al respecto?",
                            coffee: "HÃ¡blame de este cafÃ© - Â¿quÃ© lo hace especial?",
                            product: "Me interesa conocer este producto - Â¿quÃ© lo hace especial?"
                        },
                        nl: {
                            beer: "Ik ben geÃ¯nteresseerd in dit bier - wat maakt het bijzonder?",
                            wine: "Ik ben nieuwsgierig naar deze wijn - wat moet ik erover weten?",
                            coffee: "Vertel me over deze koffie - wat maakt het bijzonder?",
                            product: "Ik ben geÃ¯nteresseerd in dit product - wat maakt het bijzonder?"
                        }
                    },
                    contextualQuestions: {
                        en: {
                            taste: [
                                "What would someone who's never tried this notice first about the taste?",
                                "How does the flavor profile develop as you drink it?",
                                "What taste notes should I expect?",
                                "How would you describe the overall flavor experience?"
                            ],
                            ingredients: [
                                "What specific ingredients give this its unique character?",
                                "How do the key ingredients affect the overall profile?",
                                "What role do the main components play?",
                                "Which ingredients are most noticeable?"
                            ],
                            process: [
                                "What makes your production process special?",
                                "How does the way it's made affect the final product?",
                                "What's the most important step in creating this?",
                                "What techniques do you use that others don't?"
                            ],
                            comparison: [
                                "How does this compare to similar products?",
                                "What makes this worth choosing over alternatives?",
                                "What sets this apart from competitors?",
                                "Why should someone pick this over others?"
                            ],
                            pairing: [
                                "What would pair well with this?",
                                "When is the best time to enjoy this?",
                                "How should this be served for the best experience?",
                                "What enhances the experience of this product?"
                            ]
                        },
                        no: {
                            taste: [
                                "Hva ville noen som aldri har prÃ¸vd dette legge merke til fÃ¸rst om smaken?",
                                "Hvordan utvikler smaksprofilen seg nÃ¥r man drikker det?",
                                "Hvilke smakstoner bÃ¸r jeg forvente?",
                                "Hvordan ville du beskrive den samlede smaksopplevelsen?"
                            ],
                            ingredients: [
                                "Hvilke spesifikke ingredienser gir dette sin unike karakter?",
                                "Hvordan pÃ¥virker nÃ¸kkelingrediensene den samlede profilen?",
                                "Hvilken rolle spiller hovedkomponentene?",
                                "Hvilke ingredienser er mest merkbare?"
                            ],
                            process: [
                                "Hva gjÃ¸r produksjonsprosessen deres spesiell?",
                                "Hvordan pÃ¥virker mÃ¥ten det lages pÃ¥ det endelige produktet?",
                                "Hva er det viktigste steget i Ã¥ lage dette?",
                                "Hvilke teknikker bruker dere som andre ikke gjÃ¸r?"
                            ],
                            comparison: [
                                "Hvordan sammenligner dette seg med lignende produkter?",
                                "Hva gjÃ¸r dette verdt Ã¥ velge fremfor alternativer?",
                                "Hva skiller dette fra konkurrentene?",
                                "Hvorfor bÃ¸r noen velge dette fremfor andre?"
                            ],
                            pairing: [
                                "Hva ville passe godt sammen med dette?",
                                "NÃ¥r er det beste tidspunktet Ã¥ nyte dette?",
                                "Hvordan bÃ¸r dette serveres for beste opplevelse?",
                                "Hva forbedrer opplevelsen av dette produktet?"
                            ]
                        },
                        fi: {
                            taste: [
                                "MitÃ¤ joku, joka ei ole koskaan maistanut tÃ¤tÃ¤, huomaa ensimmÃ¤isenÃ¤ mausta?",
                                "Miten makuprofiili kehittyy juotaessa?",
                                "Millaisia makuvivahteita minun pitÃ¤isi odottaa?",
                                "Miten kuvailisit yleistÃ¤ makuelÃ¤mystÃ¤?"
                            ],
                            ingredients: [
                                "MitkÃ¤ tietyt ainesosat antavat tÃ¤lle sen ainutlaatuisen luonteen?",
                                "Miten avainainesosat vaikuttavat yleiseen profiiliin?",
                                "MikÃ¤ rooli pÃ¤Ã¤komponenteilla on?",
                                "MitkÃ¤ ainesosat ovat havaittavimpia?"
                            ],
                            process: [
                                "MikÃ¤ tekee tuotantoprosessistanne erityisen?",
                                "Miten valmistustapa vaikuttaa lopputuotteeseen?",
                                "MikÃ¤ on tÃ¤rkein vaihe tÃ¤mÃ¤n luomisessa?",
                                "MitÃ¤ tekniikoita kÃ¤ytÃ¤tte, joita muut eivÃ¤t kÃ¤ytÃ¤?"
                            ],
                            comparison: [
                                "Miten tÃ¤mÃ¤ vertautuu vastaaviin tuotteisiin?",
                                "MikÃ¤ tekee tÃ¤stÃ¤ kannattavan vaihtoehdon muihin nÃ¤hden?",
                                "MikÃ¤ erottaa tÃ¤mÃ¤n kilpailijoista?",
                                "Miksi jonkun pitÃ¤isi valita tÃ¤mÃ¤ muiden sijaan?"
                            ],
                            pairing: [
                                "MikÃ¤ sopisi hyvin tÃ¤mÃ¤n kanssa?",
                                "Milloin on paras aika nauttia tÃ¤stÃ¤?",
                                "Miten tÃ¤mÃ¤ tulisi tarjoilla parhaan kokemuksen saamiseksi?",
                                "MikÃ¤ parantaa tÃ¤mÃ¤n tuotteen kokemusta?"
                            ]
                        },
                        sv: {
                            taste: [
                                "Vad skulle nÃ¥gon som aldrig provat detta lÃ¤gga mÃ¤rke till fÃ¶rst om smaken?",
                                "Hur utvecklas smakprofilen nÃ¤r man dricker det?",
                                "Vilka smaktoner ska jag fÃ¶rvÃ¤nta mig?",
                                "Hur skulle du beskriva den Ã¶vergripande smakupplevelsen?"
                            ],
                            ingredients: [
                                "Vilka specifika ingredienser ger detta sin unika karaktÃ¤r?",
                                "Hur pÃ¥verkar nyckelingredienserna den Ã¶vergripande profilen?",
                                "Vilken roll spelar huvudkomponenterna?",
                                "Vilka ingredienser Ã¤r mest mÃ¤rkbara?"
                            ],
                            process: [
                                "Vad gÃ¶r er produktionsprocess speciell?",
                                "Hur pÃ¥verkar tillverkningssÃ¤ttet slutprodukten?",
                                "Vad Ã¤r det viktigaste steget i att skapa detta?",
                                "Vilka tekniker anvÃ¤nder ni som andra inte gÃ¶r?"
                            ],
                            comparison: [
                                "Hur jÃ¤mfÃ¶rs detta med liknande produkter?",
                                "Vad gÃ¶r detta vÃ¤rt att vÃ¤lja framfÃ¶r alternativ?",
                                "Vad skiljer detta frÃ¥n konkurrenterna?",
                                "VarfÃ¶r ska nÃ¥gon vÃ¤lja detta framfÃ¶r andra?"
                            ],
                            pairing: [
                                "Vad skulle passa bra ihop med detta?",
                                "NÃ¤r Ã¤r det bÃ¤sta tillfÃ¤llet att njuta av detta?",
                                "Hur ska detta serveras fÃ¶r bÃ¤sta upplevelse?",
                                "Vad fÃ¶rbÃ¤ttrar upplevelsen av denna produkt?"
                            ]
                        },
                        de: {
                            taste: [
                                "Was wÃ¼rde jemand, der das noch nie probiert hat, zuerst am Geschmack bemerken?",
                                "Wie entwickelt sich das Geschmacksprofil beim Trinken?",
                                "Welche Geschmacksnoten sollte ich erwarten?",
                                "Wie wÃ¼rden Sie das gesamte Geschmackserlebnis beschreiben?"
                            ],
                            ingredients: [
                                "Welche spezifischen Zutaten verleihen diesem seinen einzigartigen Charakter?",
                                "Wie beeinflussen die Hauptzutaten das Gesamtprofil?",
                                "Welche Rolle spielen die Hauptkomponenten?",
                                "Welche Zutaten sind am deutlichsten wahrnehmbar?"
                            ],
                            process: [
                                "Was macht Ihren Produktionsprozess besonders?",
                                "Wie beeinflusst die Herstellungsweise das Endprodukt?",
                                "Was ist der wichtigste Schritt bei der Herstellung?",
                                "Welche Techniken verwenden Sie, die andere nicht nutzen?"
                            ],
                            comparison: [
                                "Wie schneidet dies im Vergleich zu Ã¤hnlichen Produkten ab?",
                                "Was macht dies eine lohnenswerte Wahl gegenÃ¼ber Alternativen?",
                                "Was unterscheidet dies von der Konkurrenz?",
                                "Warum sollte sich jemand fÃ¼r dies entscheiden und nicht fÃ¼r andere?"
                            ],
                            pairing: [
                                "Was wÃ¼rde gut dazu passen?",
                                "Wann ist die beste Zeit, dies zu genieÃŸen?",
                                "Wie sollte dies fÃ¼r das beste Erlebnis serviert werden?",
                                "Was verbessert das Erlebnis dieses Produkts?"
                            ]
                        },
                        es: {
                            taste: [
                                "Â¿QuÃ© notarÃ­a primero alguien que nunca ha probado esto sobre el sabor?",
                                "Â¿CÃ³mo se desarrolla el perfil de sabor al beberlo?",
                                "Â¿QuÃ© notas de sabor debo esperar?",
                                "Â¿CÃ³mo describirÃ­as la experiencia general del sabor?"
                            ],
                            ingredients: [
                                "Â¿QuÃ© ingredientes especÃ­ficos le dan a esto su carÃ¡cter Ãºnico?",
                                "Â¿CÃ³mo afectan los ingredientes clave al perfil general?",
                                "Â¿QuÃ© papel juegan los componentes principales?",
                                "Â¿CuÃ¡les ingredientes son mÃ¡s notables?"
                            ],
                            process: [
                                "Â¿QuÃ© hace especial su proceso de producciÃ³n?",
                                "Â¿CÃ³mo afecta la forma de hacerlo al producto final?",
                                "Â¿CuÃ¡l es el paso mÃ¡s importante en la creaciÃ³n de esto?",
                                "Â¿QuÃ© tÃ©cnicas usan que otros no?"
                            ],
                            comparison: [
                                "Â¿CÃ³mo se compara esto con productos similares?",
                                "Â¿QuÃ© hace que esto valga la pena elegir sobre las alternativas?",
                                "Â¿QuÃ© distingue esto de los competidores?",
                                "Â¿Por quÃ© deberÃ­a alguien elegir esto sobre otros?"
                            ],
                            pairing: [
                                "Â¿QuÃ© irÃ­a bien con esto?",
                                "Â¿CuÃ¡ndo es el mejor momento para disfrutar esto?",
                                "Â¿CÃ³mo deberÃ­a servirse esto para la mejor experiencia?",
                                "Â¿QuÃ© mejora la experiencia de este producto?"
                            ]
                        },
                        nl: {
                            taste: [
                                "Wat zou iemand die dit nog nooit heeft geprobeerd eerst opmerken aan de smaak?",
                                "Hoe ontwikkelt het smaakprofiel zich tijdens het drinken?",
                                "Welke smaakaccenten moet ik verwachten?",
                                "Hoe zou je de algehele smaakervaring beschrijven?"
                            ],
                            ingredients: [
                                "Welke specifieke ingrediÃ«nten geven dit zijn unieke karakter?",
                                "Hoe beÃ¯nvloeden de hoofdingrediÃ«nten het algehele profiel?",
                                "Welke rol spelen de hoofdcomponenten?",
                                "Welke ingrediÃ«nten zijn het meest merkbaar?"
                            ],
                            process: [
                                "Wat maakt jullie productieproces bijzonder?",
                                "Hoe beÃ¯nvloedt de manier waarop het gemaakt wordt het eindproduct?",
                                "Wat is de belangrijkste stap in het maken hiervan?",
                                "Welke technieken gebruiken jullie die anderen niet doen?"
                            ],
                            comparison: [
                                "Hoe verhoudt dit zich tot vergelijkbare producten?",
                                "Wat maakt dit de moeite waard om te kiezen boven alternatieven?",
                                "Wat onderscheidt dit van concurrenten?",
                                "Waarom zou iemand dit kiezen boven anderen?"
                            ],
                            pairing: [
                                "Wat zou hier goed bij passen?",
                                "Wanneer is het beste moment om hiervan te genieten?",
                                "Hoe moet dit geserveerd worden voor de beste ervaring?",
                                "Wat verbetert de ervaring van dit product?"
                            ]
                        }
                    },
                    recoveryQuestions: {
                        en: [
                            "Could you tell me what customers find most interesting about this product?",
                            "What should someone know before trying this?",
                            "What makes this product stand out?",
                            "What's the story behind this product?"
                        ],
                        no: [
                            "Kan du fortelle meg hva kunder finner mest interessant ved dette produktet?",
                            "Hva bÃ¸r noen vite fÃ¸r de prÃ¸ver dette?",
                            "Hva gjÃ¸r dette produktet spesielt?",
                            "Hva er historien bak dette produktet?"
                        ],
                        fi: [
                            "Voitko kertoa mitÃ¤ asiakkaat pitÃ¤vÃ¤t mielenkiintoisimpana tÃ¤ssÃ¤ tuotteessa?",
                            "MitÃ¤ jonkun pitÃ¤isi tietÃ¤Ã¤ ennen tÃ¤mÃ¤n kokeilemista?",
                            "MikÃ¤ tekee tÃ¤stÃ¤ tuotteesta erityisen?",
                            "MikÃ¤ on tÃ¤mÃ¤n tuotteen tarina?"
                        ],
                        sv: [
                            "Kan du berÃ¤tta vad kunder tycker Ã¤r mest intressant med denna produkt?",
                            "Vad bÃ¶r nÃ¥gon veta innan de provar detta?",
                            "Vad gÃ¶r denna produkt speciell?",
                            "Vad Ã¤r historien bakom denna produkt?"
                        ],
                        de: [
                            "KÃ¶nnen Sie mir sagen, was Kunden an diesem Produkt am interessantesten finden?",
                            "Was sollte jemand wissen, bevor er das probiert?",
                            "Was macht dieses Produkt besonders?",
                            "Was ist die Geschichte hinter diesem Produkt?"
                        ],
                        es: [
                            "Â¿PodrÃ­as decirme quÃ© encuentran mÃ¡s interesante los clientes sobre este producto?",
                            "Â¿QuÃ© deberÃ­a saber alguien antes de probar esto?",
                            "Â¿QuÃ© hace que este producto se destaque?",
                            "Â¿CuÃ¡l es la historia detrÃ¡s de este producto?"
                        ],
                        nl: [
                            "Kun je me vertellen wat klanten het interessantst vinden aan dit product?",
                            "Wat zou iemand moeten weten voordat ze dit proberen?",
                            "Wat maakt dit product bijzonder?",
                            "Wat is het verhaal achter dit product?"
                        ]
                    }
                };
            }

            // Extract company name from twin identifier
            extractCompanyName(twinName) {
                const patterns = [
                    /(.+)-by-(.+)/, // "product-by-company"
                    /(.+)-(.+)/, // "product-company" 
                    /(.+)_(.+)/, // "product_company"
                ];
                
                for (const pattern of patterns) {
                    const match = twinName.match(pattern);
                    if (match) {
                        return this.capitalizeWords(match[2].replace(/[-_]/g, ' '));
                    }
                }
                
                // If no pattern matches, use the twin name as company
                return this.capitalizeWords(twinName.replace(/[-_]/g, ' '));
            }

            // Helper to capitalize words
            capitalizeWords(str) {
                return str.split(' ').map(word => 
                    word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
                ).join(' ');
            }

            // Detect product type from twin name or responses
            detectProductType(twinName, responses = []) {
                const name = twinName.toLowerCase();
                const responseText = responses.join(' ').toLowerCase();
                
                // Check for specific product types
                if (name.includes('beer') || name.includes('pilsner') || name.includes('ipa') || 
                    responseText.includes('beer') || responseText.includes('brewing')) {
                    return 'beer';
                }
                if (name.includes('wine') || responseText.includes('wine') || responseText.includes('vineyard')) {
                    return 'wine';
                }
                if (name.includes('coffee') || responseText.includes('coffee') || responseText.includes('roast')) {
                    return 'coffee';
                }
                if (name.includes('food') || name.includes('restaurant') || responseText.includes('recipe')) {
                    return 'food';
                }
                if (name.includes('service') || name.includes('software') || name.includes('app')) {
                    return 'service';
                }
                
                // Default to generic product
                return 'product';
            }

            // Generate AI-powered curious questions using secure Netlify function
            async generateCuriousQuestion(lastResponse, conversationHistory) {
                // Detect product type dynamically
                const detectedType = this.detectProductType(this.twinName, conversationHistory.map(h => h.response));
                const productType = this.config.productType === 'product' ? detectedType : this.config.productType;
                
                const conversationContext = conversationHistory
                    .slice(-3) // Last 3 exchanges for context
                    .map(h => `Customer Question: ${h.question}\n${this.config.companyName} Response: ${h.response}`)
                    .join('\n\n');

                const languageInstruction = this.selectedLanguage === 'en' ? '' : 
                    `IMPORTANT: Generate the question in ${this.selectedLanguageName}. The question must be natural and fluent in ${this.selectedLanguageName}.`;

                const prompt = `You are a curious potential customer interested in ${this.config.companyName} and their ${productType}. 

                ${languageInstruction}

                CONTEXT - Previous conversation:
                ${conversationContext}

                LATEST RESPONSE from ${this.config.companyName}:
                "${lastResponse.text}"

                YOUR TASK:
                Generate ONE specific, curious follow-up question that a potential customer would naturally ask after reading this response. The question should:

                1. **Be from a customer's perspective** - someone interested in buying/trying the ${productType}
                2. **Reference specific details** mentioned in the latest response  
                3. **Be practical and relevant** to someone considering this ${productType}
                4. **Not repeat previous questions**
                5. **Show genuine curiosity** about the ${productType}, company, or experience
                6. **Be appropriate for the ${productType} category**
                ${this.selectedLanguage !== 'en' ? `7. **Be written in fluent, natural ${this.selectedLanguageName}**` : ''}

                Generate ONLY the question - no explanations or extra text.${this.selectedLanguage !== 'en' ? ` Write the question in ${this.selectedLanguageName}.` : ''}`;

                try {
                    // Call our secure Netlify function instead of OpenAI directly
                    const response = await this.callSecureOpenAI(prompt);
                    return {
                        question: response.trim(),
                        isAIGenerated: true,
                        source: 'Secure Function',
                        language: this.selectedLanguage
                    };
                } catch (error) {
                    console.error('Secure OpenAI Error:', error.message);
                    // Fallback to multilingual template
                    const fallbackQuestion = this.generateContextualQuestion(lastResponse, productType, conversationHistory);
                    return {
                        question: fallbackQuestion,
                        isAIGenerated: false,
                        source: 'Fallback Template',
                        language: this.selectedLanguage
                    };
                }
            }

            // Call our secure Netlify function instead of OpenAI directly
            async callSecureOpenAI(prompt) {
                const response = await fetch('/.netlify/functions/openai-generate-question', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        prompt: prompt,
                        model: this.config.openaiModel
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(`Secure function error: ${error.error || 'Unknown error'}`);
                }

                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.error || 'Unknown error from secure function');
                }
                
                return data.text;
            }

            // Enhanced contextual question generator using multilingual templates
            generateContextualQuestion(lastResponse, productType = 'product', conversationHistory = []) {
                const responseText = lastResponse.text.toLowerCase();
                const askedQuestions = conversationHistory.map(h => h.question.toLowerCase());
                
                // Get the appropriate language templates
                const templates = this.multilingualQuestions.contextualQuestions[this.selectedLanguage] || 
                                 this.multilingualQuestions.contextualQuestions['en'];
                
                // Context-aware question selection based on response content
                let selectedCategory;
                if (responseText.includes('taste') || responseText.includes('flavor') || responseText.includes('aroma') ||
                    responseText.includes('smak') || responseText.includes('maku') || responseText.includes('geschmack') ||
                    responseText.includes('sabor') || responseText.includes('smaak')) {
                    selectedCategory = templates.taste;
                } else if (responseText.includes('ingredient') || responseText.includes('malt') || responseText.includes('hop') ||
                          responseText.includes('ingrediens') || responseText.includes('ainesosa') || responseText.includes('zutat') ||
                          responseText.includes('ingrediente') || responseText.includes('ingrediÃ«nt')) {
                    selectedCategory = templates.ingredients;
                } else if (responseText.includes('brew') || responseText.includes('process') || responseText.includes('made') ||
                          responseText.includes('prosess') || responseText.includes('prosessi') || responseText.includes('prozess') ||
                          responseText.includes('proceso') || responseText.includes('proces')) {
                    selectedCategory = templates.process;
                } else if (responseText.includes('pair') || responseText.includes('food') || responseText.includes('serve')) {
                    selectedCategory = templates.pairing;
                } else if (responseText.includes('different') || responseText.includes('unique') || responseText.includes('special') ||
                          responseText.includes('forskjellig') || responseText.includes('erilainen') || responseText.includes('unterschiedlich') ||
                          responseText.includes('diferente') || responseText.includes('anders')) {
                    selectedCategory = templates.comparison;
                } else {
                    // Pick a random category if no specific context matches
                    const categories = Object.keys(templates);
                    const randomCategory = categories[Math.floor(Math.random() * categories.length)];
                    selectedCategory = templates[randomCategory];
                }

                // Filter out questions too similar to ones already asked
                const availableQuestions = selectedCategory.filter(q => {
                    const qLower = q.toLowerCase();
                    return !askedQuestions.some(asked => {
                        // Check for similar words/concepts
                        const sharedWords = qLower.split(' ').filter(word => 
                            asked.includes(word) && word.length > 3
                        );
                        return sharedWords.length > 2;
                    });
                });

                // If we have available questions, pick one randomly
                if (availableQuestions.length > 0) {
                    return availableQuestions[Math.floor(Math.random() * availableQuestions.length)];
                }

                // Fallback to recovery questions if all specific ones have been used
                const recoveryQuestions = this.multilingualQuestions.recoveryQuestions[this.selectedLanguage] || 
                                        this.multilingualQuestions.recoveryQuestions['en'];
                return recoveryQuestions[Math.floor(Math.random() * recoveryQuestions.length)];
            }

            async startQueryGeneration(onNewMessage) {
                console.log(`Starting secure AI query generation for ${this.twinName} in ${this.selectedLanguageName}`);
                console.log(`Detected company: ${this.config.companyName}`);
                console.log(`Product type: ${this.detectProductType(this.twinName)}`);
                console.log(`Selected language: ${this.selectedLanguageName} (${this.selectedLanguage})`);
                
                this.isRunning = true;
                let iteration = 0;
                let aiSuccessCount = 0;
                let fallbackCount = 0;

                // Start with an appropriate introductory question in the selected language
                const productType = this.detectProductType(this.twinName);
                let currentQuestion = this.getIntroQuestion(productType);

                try {
                    while (this.isRunning && iteration < this.config.maxIterations) {
                        iteration++;
                        
                        console.log(`Iteration ${iteration}/${this.config.maxIterations}: "${currentQuestion}"`);
                        
                        // Check if we should stop before displaying question
                        if (!this.isRunning) break;
                        
                        // Display the question with loading indicator
                        await onNewMessage(currentQuestion, 'user', true);
                        
                        // Check if we should stop before fetching response
                        if (!this.isRunning) break;
                        
                        // Get response from the twin
                        const response = await fetchResponse(this.twinName, currentQuestion);
                        
                        // Remove loading indicator
                        const loadingElement = document.getElementById('audio-tour-loading');
                        if (loadingElement) {
                            loadingElement.remove();
                        }
                        
                        // Check if we should stop after getting response
                        if (!this.isRunning) break;
                        
                        if (response.success) {
                            console.log(`Response received: ${response.text.slice(0, 200)}...`);
                            
                            // Display and speak the response
                            await onNewMessage(response.text, 'ai');
                            
                            // Check if we should stop after speaking
                            if (!this.isRunning) break;
                            
                            // Store the interaction
                            const interaction = {
                                timestamp: new Date().toISOString(),
                                iteration,
                                question: currentQuestion,
                                response: response.text,
                                confidence: response.raw?.confidence || 'unknown',
                                responseLength: response.text.length,
                                language: this.selectedLanguage
                            };
                            
                            this.conversationHistory.push(interaction);
                            this.responseBuffer.push(interaction);
                            
                            // Manage buffer size
                            if (this.responseBuffer.length > this.config.bufferSize) {
                                this.responseBuffer.shift();
                            }
                            
                            // Generate next question (if not the last iteration)
                            if (iteration < this.config.maxIterations && this.isRunning) {
                                console.log('Generating next contextual question...');
                                const questionResult = await this.generateCuriousQuestion(response, this.conversationHistory);
                                currentQuestion = questionResult.question;
                                
                                // Update counters
                                if (questionResult.isAIGenerated) {
                                    aiSuccessCount++;
                                    console.log(`AI-generated: "${currentQuestion}"`);
                                } else {
                                    fallbackCount++;
                                    console.log(`Template: "${currentQuestion}"`);
                                }
                            }
                            
                        } else {
                            console.log(`Error: ${response.error}`);
                            // Generate a recovery question in the selected language
                            currentQuestion = this.getRecoveryQuestion();
                            await onNewMessage("I'd like to try a different question...", 'user');
                            fallbackCount++;
                        }
                        
                        // Wait before next iteration, but check for stop frequently
                        if (iteration < this.config.maxIterations && this.isRunning) {
                            for (let i = 0; i < this.config.delayBetweenQueries; i += 500) {
                                if (!this.isRunning) break;
                                await new Promise(resolve => setTimeout(resolve, Math.min(500, this.config.delayBetweenQueries - i)));
                            }
                        }
                    }
                } catch (error) {
                    console.error('Query generation error:', error);
                }

                console.log(`Query generation completed! Generated ${this.conversationHistory.length} responses`);
                console.log(`AI-generated questions: ${aiSuccessCount}`);
                console.log(`Template questions: ${fallbackCount}`);
                
                this.isRunning = false;
                return this.getDetailedResults();
            }

            // Get intro question in selected language using templates
            getIntroQuestion(productType) {
                const introQuestions = this.multilingualQuestions.introQuestions[this.selectedLanguage] || 
                                     this.multilingualQuestions.introQuestions['en'];
                
                return introQuestions[productType] || introQuestions.product;
            }

            // Get recovery question in selected language using templates
            getRecoveryQuestion() {
                const recoveryQuestions = this.multilingualQuestions.recoveryQuestions[this.selectedLanguage] || 
                                        this.multilingualQuestions.recoveryQuestions['en'];
                
                return recoveryQuestions[Math.floor(Math.random() * recoveryQuestions.length)];
            }

            // Get comprehensive results with analysis
            getDetailedResults() {
                const responses = this.conversationHistory.map(h => h.response).join(' ');
                
                return {
                    metadata: {
                        twinName: this.twinName,
                        companyName: this.config.companyName,
                        productType: this.detectProductType(this.twinName, this.conversationHistory.map(h => h.response)),
                        totalInteractions: this.conversationHistory.length,
                        averageResponseLength: Math.round(
                            this.conversationHistory.reduce((sum, h) => sum + h.responseLength, 0) / 
                            this.conversationHistory.length
                        ),
                        language: this.selectedLanguage,
                        languageName: this.selectedLanguageName,
                        completedAt: new Date().toISOString()
                    },
                    conversationFlow: this.conversationHistory.map(h => ({
                        iteration: h.iteration,
                        question: h.question,
                        responsePreview: h.response.slice(0, 150) + (h.response.length > 150 ? '...' : ''),
                        language: h.language
                    })),
                    fullConversation: this.conversationHistory
                };
            }

            stop() {
                console.log('Stopping query generation...');
                this.isRunning = false;
            }
        }

        const endpoint = 'https://hey.speak-to.ai/pilsner-beer-by-lervig';
        const input = document.getElementById('prompt-input');
        const sendButton = document.getElementById('send-button');
        const chatContent = document.getElementById('chat-content');
        const audioTourButton = document.getElementById('audio-tour-btn');
        const chatHeader = document.getElementById('chat-header');
        const languageSelector = document.getElementById('language-selector');
        const mainContentArea = document.getElementById('main-content-area');

        let synth = window.speechSynthesis;
        let selectedLanguage = 'en';
        let selectedLanguageName = 'English';
        let selectedLanguageCode = 'en-US';
        
        // No more exposed API key! Using secure Netlify function
        let queryGenerator = new GenerateQuery('pilsner-beer-by-lervig', {
            maxIterations: 6, // Reduced for better user experience
            delayBetweenQueries: 3000, // Slightly faster pacing
            verbose: true,
            language: selectedLanguage,
            languageName: selectedLanguageName
        });

        // Language configuration for speech synthesis
        const languageConfig = {
            'en': { code: 'en-US', name: 'English' },
            'no': { code: 'nb-NO', name: 'Norwegian' },
            'fi': { code: 'fi-FI', name: 'Finnish' },
            'sv': { code: 'sv-SE', name: 'Swedish' },
            'de': { code: 'de-DE', name: 'German' },
            'es': { code: 'es-ES', name: 'Spanish' },
            'nl': { code: 'nl-NL', name: 'Dutch' }
        };

        // Handle language selection
        document.addEventListener('DOMContentLoaded', function() {
            const languageButtons = document.querySelectorAll('.language-button');
            languageButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // Remove selected class from all buttons
                    languageButtons.forEach(btn => btn.classList.remove('selected'));
                    
                    // Add selected class to clicked button
                    this.classList.add('selected');
                    
                    // Update selected language
                    selectedLanguage = this.getAttribute('data-lang');
                    selectedLanguageName = this.getAttribute('data-lang-name');
                    selectedLanguageCode = languageConfig[selectedLanguage]?.code || 'en-US';
                    
                    console.log(`Language selected: ${selectedLanguageName} (${selectedLanguage})`);
                    
                    // Start the audio tour with selected language
                    startAudioTour();
                });
            });
        });

        // Function to transition from welcome screen to chat interface
        const minimizeHeader = () => {
            chatHeader.classList.add('minimized');
        };
        
        // Auto-scroll to the bottom of the chat
        const autoScroll = () => {
            chatContent.scrollTop = chatContent.scrollHeight;
        };

        const createMessageElement = (text, sender) => {
            const messageDiv = document.createElement('div');
            messageDiv.textContent = text;
            messageDiv.className = `message text-sm md:text-base ${sender === 'user' ? 'user-message' : 'ai-message'}`;
            return messageDiv;
        };
        
        // Updated speak function with language support and fallback
        const speak = (text) => {
            return new Promise((resolve) => {
                if (!queryGenerator.isRunning) {
                    resolve();
                    return;
                }
                
                if (synth.speaking) {
                    synth.cancel();
                }

                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = selectedLanguageCode;
                utterance.rate = 1.1; // Slightly faster speech
                
                // Try to find a voice that matches the selected language
                const voices = synth.getVoices();
                const preferredVoice = voices.find(voice => 
                    voice.lang.startsWith(selectedLanguage) || 
                    voice.lang === selectedLanguageCode
                );
                
                if (preferredVoice) {
                    utterance.voice = preferredVoice;
                    console.log(`Using voice: ${preferredVoice.name} (${preferredVoice.lang})`);
                } else {
                    console.log(`No specific voice found for ${selectedLanguageName}, using default`);
                    // Fallback to any available voice for the language code
                    const fallbackVoice = voices.find(voice => 
                        voice.lang.includes(selectedLanguage)
                    );
                    if (fallbackVoice) {
                        utterance.voice = fallbackVoice;
                        console.log(`Using fallback voice: ${fallbackVoice.name} (${fallbackVoice.lang})`);
                    }
                }

                utterance.onend = () => {
                    resolve();
                };
                utterance.onerror = (event) => {
                    console.error('SpeechSynthesisUtterance.onerror', event);
                    resolve();
                };
                
                // Check if we should still be running before speaking
                if (queryGenerator.isRunning) {
                    synth.speak(utterance);
                } else {
                    resolve();
                }
            });
        };

        const sendMessage = async (prompt) => {
            if (!prompt.trim()) return;

            // Minimize header on first message
            minimizeHeader();

            // Add user message to UI
            chatContent.appendChild(createMessageElement(prompt, 'user'));
            autoScroll();
            input.value = '';
            sendButton.disabled = true;

            try {
                // Show loading indicator
                const loadingDiv = document.createElement('div');
                loadingDiv.className = 'ai-message flex items-center';
                loadingDiv.innerHTML = '<div class="loading-dots"><span>.</span><span>.</span><span>.</span></div>';
                chatContent.appendChild(loadingDiv);
                autoScroll();

                const response = await fetchResponse('pilsner-beer-by-lervig', prompt);

                // Remove loading indicator
                chatContent.removeChild(loadingDiv);

                if (response.success) {
                    const answer = response.text || "Sorry, I couldn't get a response. Please try again.";
                    chatContent.appendChild(createMessageElement(answer, 'ai'));
                    autoScroll();
                } else {
                    showModal('Failed to fetch response after multiple retries. Please check your network connection.');
                    console.error('Error fetching response:', response.error);
                }
            } catch (error) {
                showModal('An unexpected error occurred. Please try again.');
                console.error('Error:', error);
            } finally {
                sendButton.disabled = false;
            }
        };

        
        // Function to start audio tour with selected language
        const startAudioTour = async () => {
            // Hide language selector and remove margin
            languageSelector.style.display = 'none';
            mainContentArea.classList.remove('with-language-selector');
            
            // Minimize header and transition to chat interface
            minimizeHeader();
            
            // Update button state
            audioTourButton.textContent = 'Stop Audio Tour';
            audioTourButton.classList.add('stop');
            input.disabled = true;
            sendButton.disabled = true;

            // Create a new instance for each tour to reset state with selected language
            queryGenerator = new GenerateQuery('pilsner-beer-by-lervig', {
                maxIterations: 6,
                delayBetweenQueries: 3000,
                verbose: true,
                language: selectedLanguage,
                languageName: selectedLanguageName
            });

            const onNewMessage = async (text, sender, showLoading = false) => {
                // Double-check if we should still be running
                if (!queryGenerator.isRunning) return;
                
                chatContent.appendChild(createMessageElement(text, sender));
                autoScroll();
                
                // Show loading indicator after user questions
                let loadingDiv = null;
                if (showLoading && sender === 'user' && queryGenerator.isRunning) {
                    loadingDiv = document.createElement('div');
                    loadingDiv.className = 'ai-message flex items-center';
                    loadingDiv.innerHTML = '<div class="loading-dots"><span>.</span><span>.</span><span>.</span></div>';
                    loadingDiv.id = 'audio-tour-loading'; // Add ID for easy removal
                    chatContent.appendChild(loadingDiv);
                    autoScroll();
                }
                
                // Speak both user questions and AI responses in selected language
                if (queryGenerator.isRunning) {
                    await speak(text);
                }
                
                // Small delay after user questions for natural conversation flow
                if (sender === 'user' && queryGenerator.isRunning) {
                    await new Promise(resolve => {
                        const delay = setTimeout(() => resolve(), 1000);
                        // Check periodically if we should cancel the delay
                        const checkInterval = setInterval(() => {
                            if (!queryGenerator.isRunning) {
                                clearTimeout(delay);
                                clearInterval(checkInterval);
                                resolve();
                            }
                        }, 100);
                    });
                }
                
                return loadingDiv; // Return loading div reference for removal
            };

            try {
                await queryGenerator.startQueryGeneration(onNewMessage);
            } catch (error) {
                console.error('Audio tour error:', error);
                showModal('Audio tour encountered an error. Please try again.');
            } finally {
                // Always reset UI state when tour completes or is stopped
                if (audioTourButton.textContent === 'Stop Audio Tour') {
                    audioTourButton.textContent = 'Start Audio Tour';
                    audioTourButton.classList.remove('stop');
                    input.disabled = false;
                    sendButton.disabled = false;
                }
                
                if (synth.speaking) {
                    synth.cancel();
                }
            }
        };

        sendButton.addEventListener('click', () => {
            sendMessage(input.value);
        });

        input.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage(input.value);
            }
        });
        
        audioTourButton.addEventListener('click', async () => {
            if (queryGenerator.isRunning) {
                // Stop everything immediately
                queryGenerator.stop();
                
                // Cancel any ongoing speech
                if (synth.speaking) {
                    synth.cancel();
                }
                
                // Reset UI immediately
                audioTourButton.textContent = 'Start Audio Tour';
                audioTourButton.classList.remove('stop');
                input.disabled = false;
                sendButton.disabled = false;
                languageSelector.style.display = 'none';
                mainContentArea.classList.remove('with-language-selector');
                
                console.log('Audio tour stopped by user');
            } else {
                // Show language selector and add margin to content
                languageSelector.style.display = 'flex';
                mainContentArea.classList.add('with-language-selector');
                
                // Don't start tour immediately - wait for language selection
                console.log('Language selector displayed. Waiting for language selection...');
            }
        });

    </script>
</body>
</html>